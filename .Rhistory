"5-Hydroxyindole-3-acetic acid",
"N-Acetyl-5-hydroxytryptamine",
"2-Picolinic acid",
"Trigonelline",
"Indole-3-propionic acid"
)
aas <- c(
"Glutamic acid",
"Proline",
"Serine",
"Threonine",
"Valine",
"Alanine",
"Aspartic acid",
"Glycine",
"Isoleucine",
"Leucine",
"Phenylalanine")
lcp4 <- c("#95C65C","#B25D91","#FF3F38")
joined_df <- sta_lst_sig
joined_df <- subset(joined_df, variable%in%tryp_mets)
vg <- log_df1[log_df1$variable %in% joined_df$variable, ]
colnames(vg) <- c("rowname","Label","variable","log2 Concentration")
vg$Label <- factor(vg$Label, levels=c("1","10","8"))
maxim_val <- apply(df_norm_lab4[, which(colnames(df_norm_lab4)%in%tryp_mets)], 2, max)
maxim_val <- maxim_val + 0.5
joined_df$y.position <- c(sapply(maxim_val, function(x) rep(x,3)))
four4 <- ggboxplot(vg, x = "Label", y = "log2 Concentration", color = "Label", facet.by = "variable", fill = "Label", alpha=0.4) + geom_point(aes(color = vg$Label)) +
facet_wrap(~ variable, scales = "free", ncol = 4) +
stat_pvalue_manual(joined_df, label = "p.adj.signif", y.position = "y.position",hide.ns = TRUE,step.increase = 0.2,bracket.nudge.y = -0.5) +
theme(
axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),plot.background = element_rect(fill = "transparent",colour = NA), legend.position = "bottom",legend.text = element_text(size=12),legend.title=element_text(size=12),legend.box.spacing = unit(0.5, "in")) +
scale_color_manual(values = lcp4, labels = c("Control","Hyperglutamatergic","Hypoglutamatergic")) +
scale_fill_manual(values = lcp4, labels = c("Control","Hyperglutamatergic","Hypoglutamatergic"))
print(four4)
uni1 <- wrap_elements((as.grob(four4)))
joined_df <- sta_lst_sig
joined_df <- subset(joined_df, variable%in%aas)
vg <- log_df1[log_df1$variable %in% joined_df$variable, ]
colnames(vg) <- c("rowname","Label","variable","log2 Concentration")
vg$Label <- factor(vg$Label, levels=c("1","10","8"))
maxim_val <- apply(df_norm_lab4[, which(colnames(df_norm_lab4)%in%aas)], 2, max)
maxim_val <- maxim_val + 0.05
joined_df$y.position <- c(sapply(maxim_val, function(x) rep(x,3)))
four4 <- ggboxplot(vg, x = "Label", y = "log2 Concentration", color = "Label", facet.by = "variable", fill = "Label", alpha=0.4) + geom_point(aes(color = vg$Label)) +
facet_wrap(~ variable, scales = "free", ncol = 4) +
stat_pvalue_manual(joined_df, label = "p.adj.signif", y.position = "y.position",hide.ns = TRUE,step.increase = 0.1) +
theme(
axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),plot.background = element_rect(fill = "transparent",colour = NA),legend.position = "none"
) +
scale_color_manual(values = lcp4, labels = c("Control","Hyperglutamatergic","Hypoglutamatergic")) +
scale_fill_manual(values = lcp4, labels = c("Control","Hyperglutamatergic","Hypoglutamatergic"))
print(four4)
uni2 <- wrap_elements((as.grob(four4)))
full_four <- uni1 / uni2 + plot_annotation(tag_levels = list(c("B","C")))
ggsave(file=here("paper/Figures/4.png"),plot=full_four, dpi = 1000,bg="white" ,width = 8, height = 11.4, units = "in")
vip_p <- vip_g
vip_p$`Hyperglutamatergic`$diffexpressed <- "None"
vip_p$`Hyperglutamatergic`$diffexpressed[vip_p$`Hyperglutamatergic`$VIP >= 1] <- "MVA"
vip_p$`Hyperglutamatergic`$diffexpressed[vip_p$`Hyperglutamatergic`$p.adj < 0.05] <- "UVA"
vip_p$`Hyperglutamatergic`$diffexpressed[vip_p$`Hyperglutamatergic`$p.adj < 0.05 & vip_p$`Hyperglutamatergic`$VIP > 1] <- "UVA+MVA"
vip_p$`Hyperglutamatergic`$diffexpressed <- factor(vip_p$`Hyperglutamatergic`$diffexpressed, levels = c("UVA+MVA", "MVA", "UVA", "None"))
vip_p$Hypoglutamatergic$diffexpressed <- "None"
vip_p$Hypoglutamatergic$diffexpressed[vip_p$Hypoglutamatergic$VIP >= 1] <- "MVA"
vip_p$Hypoglutamatergic$diffexpressed[vip_p$Hypoglutamatergic$p.adj < 0.05] <- "UVA"
vip_p$Hypoglutamatergic$diffexpressed[vip_p$Hypoglutamatergic$p.adj < 0.05 & vip_p$Hypoglutamatergic$VIP >= 1] <- "UVA+MVA"
vip_p$Hypoglutamatergic$diffexpressed <- factor(vip_p$Hypoglutamatergic$diffexpressed, levels = c("UVA+MVA", "MVA", "UVA", "None"))
col_op <- c("#B25D91", "#FF3F38","#95C65C")
names(col_op) <- c("Hyperglutamatergic","Hypoglutamatergic", "Control")
two_e <- ggplot(data =  vip_p$Hypoglutamatergic, aes(x = p.adj, y = VIP, label=Metabolite, col=diffexpressed)) +
geom_vline(xintercept = 0.05, col = "darkgray", linetype = 'dashed') +
geom_hline(yintercept = 1, col = "darkgray", linetype = 'dashed') +
geom_point(size = 3) +
scale_color_manual(values = c("#9900F0", "#FF00E4", "#38E54D","grey"), # to set the colors of our variable
labels = c("UVA+MVA", "MVA", "UVA", "None"), breaks = levels(vip_p$Hypoglutamatergic$diffexpressed)) +
theme_light() +
labs(color = 'Altered', #legend_title,
x = "p-value", y = "VIP score", title=NULL) +
theme(legend.position = "bottom") +
xlim(c(0,1))
two_f <- ggplot(data=vip_p$`Hyperglutamatergic` ,aes(x = p.adj, y = VIP,  label=Metabolite,col=diffexpressed)) +
geom_vline(xintercept = 0.05, col = "darkgray", linetype = 'dashed') +
geom_hline(yintercept = 1, col = "darkgray", linetype = 'dashed') +
geom_point(size = 3) +
scale_color_manual(values = c("#9900F0","#FF00E4","#38E54D",  "grey"), # to set the colours of our variable
labels = c("UVA+MVA", "MVA", "UVA", "None"), breaks = levels(vip_p$`Hyperglutamatergic`$diffexpressed)) +
theme_light() +
labs(color = 'Altered',
x = "p-value", y = "VIP score", title=NULL) +
theme(legend.position = "bottom")
patchva <- two_e + two_f  + plot_annotation(tag_levels = list(c("E","F"))) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
ggsave(file=here("paper/Figures/fig_2E_F.png"),patchva,dpi = 500,width = 8, height = 4, units = "in")
vip_g2 <- vip_g$Hyperglutamatergic[order(vip_g$Hyperglutamatergic$VIP, decreasing = TRUE),]
vip_g2 <- subset(vip_g2, VIP > 1)
vip_g2$color <- factor(names(vip_g[1]),levels=c("Hyperglutamatergic","Hypoglutamatergic"))
two_c <- vip_g2 %>%
filter(!is.na(VIP)) %>%
arrange(VIP) %>%
mutate(Metabolite = factor(Metabolite, Metabolite)) %>%
ggplot(aes(x = Metabolite, y = VIP, size = 2, fill = color)) +
geom_col(size=5) +
coord_flip() +
theme_bw(base_size = 12) +
xlab("") +
ylab("VIP scores") +
ylim(0, 4) +
guides(size = "none") +
scale_fill_manual(values = col_op[1], labels = "Hyperglutamatergic") +
theme(legend.title=element_blank(),legend.position = "bottom")
vip_g2 <- vip_g$`Hypoglutamatergic`[order(vip_g$`Hypoglutamatergic`$VIP, decreasing = TRUE),]
vip_g2 <- subset(vip_g2, VIP > 1)
vip_g2$color <- factor(names(vip_g[2]),levels=c("Hyperglutamatergic","Hypoglutamatergic"))
two_d <- vip_g2 %>%
filter(!is.na(VIP)) %>%
arrange(VIP) %>%
mutate(Metabolite = factor(Metabolite, Metabolite)) %>%
ggplot(aes(x = Metabolite, y = VIP, size = 2, fill = color)) +
geom_col(size=5) +
coord_flip() +
theme_bw(base_size = 12) +
xlab("") +
ylab("VIP scores") +
ylim(0, 4) +
guides(size = "none") +
scale_fill_manual(values = col_op[2], labels = "Hypoglutamatergic") +
theme(legend.title=element_blank(),legend.position = "bottom") +
scale_x_discrete(position = "top")
patchvip <- two_c + two_d + plot_annotation(tag_levels = list(c("C","D"))) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
ggsave(file=here("paper/Figures/fig_2C_D.png"),patchvip,dpi = 500,width = 8,height = 3.5, units = "in")
df_metg <- df_norm_lab4
df_metg <- subset(df_metg,Label%in%c(1,10))
df_metg <- data.frame(t(df_metg),check.names = FALSE)
df_metg <- row_to_names(df_metg,1)
mat_allg <- as.matrix(df_metg)
lab <- data.frame(as.factor(mat_allg[1,]))
lab$as.factor.mat_allg.1.... <- gsub(10,"Hyperglutamatergic     ",lab$as.factor.mat_allg.1....)
lab$as.factor.mat_allg.1.... <- gsub(1,"Control",lab$as.factor.mat_allg.1....)
colnames(lab)<-"Label"
lab$Label<- factor(lab$Label,levels = c("Control","Hyperglutamatergic     "),ordered = TRUE)
mat_allg <- apply(mat_allg[-1,],c(1,2),as.numeric)
lc <- c("#95C65C","#B25D91")
names(lc) <-  levels(lab$Label)
lc <- list(Label = lc)
p6 <- pheatmap(mat_allg, annotation = lab,clustering_method = "ward.D2",fontsize = 10,show_colnames = TRUE,show_rownames = FALSE, border_color = NA, annotation_colors = lc, fontsize_col = 10, color = colorRampPalette(c("blue","red"))(100), cluster_rows = TRUE,scale = "row",legend = TRUE, annotation_legend = TRUE, cellwidth = 10, cellheight = 2)
p6 <- wrap_elements(as.grob(p6))
df_metg <- df_norm_lab4
df_metg <- subset(df_metg,Label%in%c(1,8))
df_metg <- data.frame(t(df_metg),check.names = FALSE)
df_metg <- row_to_names(df_metg,1)
mat_allg <- as.matrix(df_metg)
lab <- data.frame(as.factor(mat_allg[1,]))
lab$as.factor.mat_allg.1.... <- gsub(8,"Hypoglutamatergic",lab$as.factor.mat_allg.1....)
lab$as.factor.mat_allg.1.... <- gsub(1,"Control",lab$as.factor.mat_allg.1....)
colnames(lab)<-"Label"
lab$Label<- factor(lab$Label,levels = c("Control","Hypoglutamatergic"),ordered = TRUE)
mat_allg <- apply(mat_allg[-1,],c(1,2),as.numeric)
lc <- c("#95C65C","#FF3F38")
names(lc) <-  levels(lab$Label)
lc <- list(Label = lc)
p5 <- pheatmap(mat_allg, annotation = lab,clustering_method = "ward.D2",fontsize = 10,show_colnames = TRUE,show_rownames = FALSE, border_color = NA, annotation_colors = lc, color = colorRampPalette(c("blue","red"))(100), cluster_rows = TRUE,scale = "row",legend = TRUE, annotation_legend = TRUE, cellwidth = 10, cellheight = 2)
p5 <- wrap_elements(as.grob(p5))
patchhc1 <- p6 + p5 + plot_annotation(tag_levels = list(c("E","F")))
ggsave(file=here("paper/Figures/fig_1E_F.png"),patchhc1,dpi = 1000,scale=1.5,width = 8, height = 3, units = "in")
rt <- gsub("10", "Hyperglutamatergic", subset(df_norm_lab4,Label%in%c(1,10))$Label)
rt <- gsub("1", "Control", rt)
rt <- factor(rt,levels = c("Control","Hyperglutamatergic","Hypoglutamatergic"))
gr <- gsub("8", "Hypoglutamatergic", subset(df_norm_lab4,Label%in%c(1,8))$Label)
gr <- gsub("1", "Control", gr)
gr <- factor(gr,levels = c("Control","Hyperglutamatergic","Hypoglutamatergic"))
opdf <- data.frame("lab"=rt,"x"=pd_g$Hyperglutamatergic@scoreMN,"y"=pd_g$Hyperglutamatergic@orthoScoreMN)
opdf2 <- data.frame("lab"=gr,"x"=pd_g$`Hypoglutamatergic`@scoreMN,"y"=pd_g$`Hypoglutamatergic`@orthoScoreMN)
# par(mfrow=c(1,2))
two_a <- opdf %>%
ggplot(aes(x=p1,y=o1,color=lab)) +
geom_point(size=3) +
stat_ellipse(geom = "polygon",
aes(fill = lab),
alpha = 0.25,
level = 0.8) +
coord_fixed(xlim = c(-10,10),ylim=c(-5,5)) +
theme_bw(base_size = 15) +
scale_color_manual(values=c("#95C65C","#B25D91","#FF3F38"),labels=c("Control","Hyperglutamatergic","Hypoglutamatergic"),drop = FALSE) +
scale_fill_manual(values=c("#95C65C","#B25D91","#FF3F38"),labels=c("Control","Hyperglutamatergic","Hypoglutamatergic"),drop = FALSE) +
theme(legend.title = element_blank()) +
geom_vline(xintercept=0) +
geom_hline(yintercept = 0)
two_b <- opdf2 %>%
ggplot(aes(x=p1,y=o1,color=lab)) +
geom_point(size=3) +
stat_ellipse(geom = "polygon",
aes(fill = lab),
alpha = 0.25,
level = 0.8) +
coord_fixed(xlim = c(-10,10),ylim=c(-5,5)) +
theme_bw(base_size = 15) +
scale_color_manual(values=c("#95C65C","#B25D91","#FF3F38"),drop = FALSE) +
scale_fill_manual(values=c("#95C65C","#B25D91","#FF3F38"),drop = FALSE) +
theme(legend.title = element_blank()) +
geom_vline(xintercept=0) +
geom_hline(yintercept = 0)
patchop <- two_a   + two_b + plot_annotation(tag_levels = "A")  + plot_layout(guides = "collect") & theme(legend.position = 'right')
ggsave(file=here("paper/Figures/fig_2A_B.png"),patchop,dpi = 500,width = 8, height = 3, units = "in")
df_metg <- df_norm_lab4[,c("rowname","Label",(sels$Hyperglutamatergic))]
df_metg <- column_to_rownames(df_metg,"rowname")
df_metg <- subset(df_metg,Label%in%c(1,10))
df_metg <- data.frame(t(df_metg),check.names = FALSE)
mat_allg <- as.matrix(df_metg)
lab <- data.frame(as.factor(mat_allg[1,]))
lab$as.factor.mat_allg.1.... <- gsub(10,"Hyperglutamatergic     ",lab$as.factor.mat_allg.1....)
lab$as.factor.mat_allg.1.... <- gsub(1,"Control",lab$as.factor.mat_allg.1....)
colnames(lab)<-"Label"
lab$Label<- factor(lab$Label,levels = c("Control","Hyperglutamatergic     ","Hypoglutamatergic     "),ordered = TRUE)
mat_allg <- apply(mat_allg[-1,],c(1,2),as.numeric)
lc <- c("#95C65C","#B25D91","#FF3F38")
names(lc) <-  levels(lab$Label)
lc <- list(Label = lc)
p6 <- pheatmap(mat_allg, annotation = lab,clustering_method = "ward.D2",fontsize = 10,show_colnames = TRUE,show_rownames = TRUE, border_color = NA, annotation_colors = lc, fontsize_col = 10, color = colorRampPalette(c("blue","red"))(100), cluster_rows = TRUE,scale = "row",legend = TRUE, annotation_legend = FALSE, cellwidth = 12, cellheight = 9)
ggsave(file=here("paper/Figures/fig_2G.png"),p6,dpi = 500,width = 4,scale=2, height = 3, units = "in")
p6 <- wrap_elements(as.grob(p6))
df_metg <- df_norm_lab4[,c("rowname","Label",(sels$Hypoglutamatergic))]
df_metg <- column_to_rownames(df_metg,"rowname")
df_metg <- subset(df_metg,Label%in%c(1,8))
df_metg <- data.frame(t(df_metg),check.names = FALSE)
mat_allg <- as.matrix(df_metg)
lab <- data.frame(as.factor(mat_allg[1,]))
lab$as.factor.mat_allg.1.... <- gsub(8,"Hyperglutamatergic     ",lab$as.factor.mat_allg.1....)
lab$as.factor.mat_allg.1.... <- gsub(1,"Control",lab$as.factor.mat_allg.1....)
colnames(lab)<-"Label"
lab$Label<- factor(lab$Label,levels = c("Control","Hyperglutamatergic     ","Hypoglutamatergic     "),ordered = TRUE)
mat_allg <- apply(mat_allg[-1,],c(1,2),as.numeric)
lc <- c("#95C65C","#FF3F38","#B25D91")
names(lc) <-  levels(lab$Label)
lc <- list(Label = lc)
p7 <- pheatmap(mat_allg, annotation = lab,clustering_method = "ward.D2",fontsize = 12,show_colnames = TRUE,show_rownames = TRUE, border_color = NA, annotation_colors = lc, fontsize_col = 12, color = colorRampPalette(c("blue","red"))(100), cluster_rows = TRUE,scale = "row",legend = TRUE, annotation_legend = FALSE, cellwidth = 15, cellheight = 10)
p7 <- wrap_elements(as.grob(p7))
ggsave(file=here("paper/Figures/fig_2H.png"),p7,dpi = 500,width = 4,scale=2, height = 3, units = "in")
patchhc2 <- p6+p7+plot_annotation(tag_levels = list(c("G","H")))
ggsave(file=here("paper/Figures/fig_2G_H.png"),patchhc2,dpi = 1000,scale=1.5,width = 10, height = 3,units = "in")
pat_char <-  read.csv(here("metadata/patient_characteristics.csv"),sep=";")
# Checking for effect medications
# pat_contrl <-  subset(pat_char,!(pat_char$Disease=="Control"))
pat_ctrl_meds <- pat_char[,c("ID","Medications")]
meds_lst <- strsplit(pat_ctrl_meds$Medications,",")
names(meds_lst) <- pat_ctrl_meds$ID
meds_lst <- lapply(meds_lst, function(x) toupper(str_squish(x)))
meds_lst <- lapply(meds_lst, data.frame)
meds_lst <- lapply(meds_lst, function(x) setNames(x, "Medication"))
meds_lst <- lapply(names(meds_lst), function(x) meds_lst[[x]] %>%
mutate(value = 1, id = x, Medication=factor(Medication)))
meds_lst <- bind_rows(meds_lst)
prop_meds <- data.frame(table(meds_lst$Medication))
prop_meds <- subset(prop_meds, Freq>3)
colnames(prop_meds) <- c("Medication","Freq")
one_hot_encoded <- meds_lst %>%
pivot_wider(names_from = Medication, values_from = value, values_fill = 0)
one_hot_encoded <- one_hot_encoded[,colnames(one_hot_encoded)%in%c("id",as.character(prop_meds$Medication))]
df_norm_meds <- df_norm_lab[,-1]
df_norm_meds <- rownames_to_column(df_norm_meds,var = "id")
df_norm_meds$id <- make.names(df_norm_meds$id)
med.test <- list()
for (i in prop_meds$Medication) {
df_norm_meds <- merge(one_hot_encoded[,c("id",i)],df_norm_meds)
long_med <- melt(df_norm_meds, id.vars=c("id",i))
colnames(long_med) <- c("id",make.names(i),"variable","value")
med.test[[i]] <-
long_med %>%
group_by(variable) %>%
wilcox_test(as.formula(paste0("value ~ ",make.names(i)))) %>%
adjust_pvalue(method="fdr") %>%
add_significance("p.adj")
}
# Checking effect of age
pat_contrl <-  pat_char
pat_contrl <-  pat_contrl[order(pat_contrl$ID),]
# pat_contrl <-  subset(pat_contrl,!(pat_contrl$Disease=="Control"))
df_norm_age <- df_norm_lab
df_norm_age <- rownames_to_column(df_norm_age,var = "ID")
df_norm_age <- subset(df_norm_age, make.names(df_norm_age$ID)%in%pat_contrl$ID)
df_norm_age$Label <- pat_contrl$Age
df_norm_age <- df_norm_age[complete.cases(df_norm_age),]
log_df_age <- melt(df_norm_age, id.vars = c("ID","Label"))
cor_age <- log_df_age %>%
group_by(variable) %>%
cor_test(Label, value, method= "spearman")  %>%
adjust_pvalue(method = "fdr") %>%
add_significance("p.adj")
write.csv(cor_age,file=here("paper/Tables/correlation_age.csv"))
# Checking effect of sex
pat_contrl <-  read.csv(here("metadata/patient_characteristics.csv"),sep=";")
pat_contrl <-  pat_contrl[,-7]
pat_contrl <-  pat_contrl[order(pat_contrl$ID),]
df_norm_sex <- df_norm_lab
df_norm_sex <- rownames_to_column(df_norm_sex,var = "ID")
df_norm_sex <- subset(df_norm_sex, make.names(df_norm_sex$ID)%in%pat_contrl$ID)
df_norm_sex$Label <- factor(pat_contrl$Sex)
df_norm_sex <- df_norm_sex[complete.cases(df_norm_sex),]
log_df_sex <- melt(df_norm_sex, id.vars = c("ID","Label"))
comp_sex <- log_df_sex %>%
group_by(variable) %>%
wilcox_test(as.formula(value ~ Label), p.adjust.method = NULL) %>%
adjust_pvalue(method = "fdr") %>%
add_significance("p.adj")
write.csv(comp_sex,file=here("paper/Tables/comparing_sex.csv"))
rownames(df_norm_sex) <- df_norm_sex$ID
oplsda_sex <- opls(df_norm_sex[,-c(1,2)],as.factor(df_norm_sex$Label),orthoI = 1,predI=1,scaleC = "center", permI = 1000)
sx <- factor(df_norm_sex$Label)
opsx <- data.frame("lab"=sx,"x"=oplsda_sex@scoreMN,"y"=oplsda_sex@orthoScoreMN)
opsx %>%
ggplot(aes(x=p1,y=o1,color=lab)) +
geom_point(size=3) +
stat_ellipse(geom = "polygon",
aes(fill = lab),
alpha = 0.25,
level = 0.8) +
coord_fixed(xlim = c(-10,10),ylim=c(-5,5)) +
theme_bw(base_size = 15) +
scale_color_manual(values=c("pink","lightblue"),labels=c("F","M"),drop = FALSE) +
scale_fill_manual(values=c("pink","lightblue"),labels=c("F","M"),drop = FALSE) +
theme(legend.title = element_blank()) +
geom_vline(xintercept=0) +
geom_hline(yintercept = 0)
library(writexl)
write_xlsx(
med.test,
path = here(fileext = here("paper/Tables/medications.xlsx")),
col_names = TRUE,
format_headers = TRUE,
use_zip64 = FALSE
)
med.test
log_df_age
long_med
df_norm_meds
pat_char <-  read.csv(here("metadata/patient_characteristics.csv"),sep=";")
# Checking for effect medications
# pat_contrl <-  subset(pat_char,!(pat_char$Disease=="Control"))
pat_ctrl_meds <- pat_char[,c("ID","Medications")]
meds_lst <- strsplit(pat_ctrl_meds$Medications,",")
names(meds_lst) <- pat_ctrl_meds$ID
meds_lst <- lapply(meds_lst, function(x) toupper(str_squish(x)))
meds_lst <- lapply(meds_lst, data.frame)
meds_lst <- lapply(meds_lst, function(x) setNames(x, "Medication"))
meds_lst <- lapply(names(meds_lst), function(x) meds_lst[[x]] %>%
mutate(value = 1, id = x, Medication=factor(Medication)))
meds_lst <- bind_rows(meds_lst)
prop_meds <- data.frame(table(meds_lst$Medication))
prop_meds <- subset(prop_meds, Freq>3)
colnames(prop_meds) <- c("Medication","Freq")
one_hot_encoded <- meds_lst %>%
pivot_wider(names_from = Medication, values_from = value, values_fill = 0)
one_hot_encoded <- one_hot_encoded[,colnames(one_hot_encoded)%in%c("id",as.character(prop_meds$Medication))]
df_norm_meds <- df_norm_lab[,-1]
df_norm_meds <- rownames_to_column(df_norm_meds,var = "id")
df_norm_meds$id <- make.names(df_norm_meds$id)
med.test <- list()
for (i in prop_meds$Medication) {
df_norm_meds_i <- merge(one_hot_encoded[,c("id",i)],df_norm_meds_i)
long_med <- melt(df_norm_meds_i, id.vars=c("id",i))
colnames(long_med) <- c("id",make.names(i),"variable","value")
med.test[[i]] <-
long_med %>%
group_by(variable) %>%
wilcox_test(as.formula(paste0("value ~ ",make.names(i)))) %>%
adjust_pvalue(method="fdr") %>%
add_significance("p.adj")
}
pat_char <-  read.csv(here("metadata/patient_characteristics.csv"),sep=";")
# Checking for effect medications
# pat_contrl <-  subset(pat_char,!(pat_char$Disease=="Control"))
pat_ctrl_meds <- pat_char[,c("ID","Medications")]
meds_lst <- strsplit(pat_ctrl_meds$Medications,",")
names(meds_lst) <- pat_ctrl_meds$ID
meds_lst <- lapply(meds_lst, function(x) toupper(str_squish(x)))
meds_lst <- lapply(meds_lst, data.frame)
meds_lst <- lapply(meds_lst, function(x) setNames(x, "Medication"))
meds_lst <- lapply(names(meds_lst), function(x) meds_lst[[x]] %>%
mutate(value = 1, id = x, Medication=factor(Medication)))
meds_lst <- bind_rows(meds_lst)
prop_meds <- data.frame(table(meds_lst$Medication))
prop_meds <- subset(prop_meds, Freq>3)
colnames(prop_meds) <- c("Medication","Freq")
one_hot_encoded <- meds_lst %>%
pivot_wider(names_from = Medication, values_from = value, values_fill = 0)
one_hot_encoded <- one_hot_encoded[,colnames(one_hot_encoded)%in%c("id",as.character(prop_meds$Medication))]
df_norm_meds <- df_norm_lab[,-1]
df_norm_meds <- rownames_to_column(df_norm_meds,var = "id")
df_norm_meds$id <- make.names(df_norm_meds$id)
med.test <- list()
for (i in prop_meds$Medication) {
df_norm_meds_i <- merge(one_hot_encoded[,c("id",i)],df_norm_meds)
long_med <- melt(df_norm_meds_i, id.vars=c("id",i))
colnames(long_med) <- c("id",make.names(i),"variable","value")
med.test[[i]] <-
long_med %>%
group_by(variable) %>%
wilcox_test(as.formula(paste0("value ~ ",make.names(i)))) %>%
adjust_pvalue(method="fdr") %>%
add_significance("p.adj")
}
# Checking effect of age
pat_contrl <-  pat_char
pat_contrl <-  pat_contrl[order(pat_contrl$ID),]
# pat_contrl <-  subset(pat_contrl,!(pat_contrl$Disease=="Control"))
df_norm_age <- df_norm_lab
df_norm_age <- rownames_to_column(df_norm_age,var = "ID")
df_norm_age <- subset(df_norm_age, make.names(df_norm_age$ID)%in%pat_contrl$ID)
df_norm_age$Label <- pat_contrl$Age
df_norm_age <- df_norm_age[complete.cases(df_norm_age),]
log_df_age <- melt(df_norm_age, id.vars = c("ID","Label"))
cor_age <- log_df_age %>%
group_by(variable) %>%
cor_test(Label, value, method= "spearman")  %>%
adjust_pvalue(method = "fdr") %>%
add_significance("p.adj")
write.csv(cor_age,file=here("paper/Tables/correlation_age.csv"))
# Checking effect of sex
pat_contrl <-  read.csv(here("metadata/patient_characteristics.csv"),sep=";")
pat_contrl <-  pat_contrl[,-7]
pat_contrl <-  pat_contrl[order(pat_contrl$ID),]
df_norm_sex <- df_norm_lab
df_norm_sex <- rownames_to_column(df_norm_sex,var = "ID")
df_norm_sex <- subset(df_norm_sex, make.names(df_norm_sex$ID)%in%pat_contrl$ID)
df_norm_sex$Label <- factor(pat_contrl$Sex)
df_norm_sex <- df_norm_sex[complete.cases(df_norm_sex),]
log_df_sex <- melt(df_norm_sex, id.vars = c("ID","Label"))
comp_sex <- log_df_sex %>%
group_by(variable) %>%
wilcox_test(as.formula(value ~ Label), p.adjust.method = NULL) %>%
adjust_pvalue(method = "fdr") %>%
add_significance("p.adj")
write.csv(comp_sex,file=here("paper/Tables/comparing_sex.csv"))
rownames(df_norm_sex) <- df_norm_sex$ID
oplsda_sex <- opls(df_norm_sex[,-c(1,2)],as.factor(df_norm_sex$Label),orthoI = 1,predI=1,scaleC = "center", permI = 1000)
sx <- factor(df_norm_sex$Label)
opsx <- data.frame("lab"=sx,"x"=oplsda_sex@scoreMN,"y"=oplsda_sex@orthoScoreMN)
opsx %>%
ggplot(aes(x=p1,y=o1,color=lab)) +
geom_point(size=3) +
stat_ellipse(geom = "polygon",
aes(fill = lab),
alpha = 0.25,
level = 0.8) +
coord_fixed(xlim = c(-10,10),ylim=c(-5,5)) +
theme_bw(base_size = 15) +
scale_color_manual(values=c("pink","lightblue"),labels=c("F","M"),drop = FALSE) +
scale_fill_manual(values=c("pink","lightblue"),labels=c("F","M"),drop = FALSE) +
theme(legend.title = element_blank()) +
geom_vline(xintercept=0) +
geom_hline(yintercept = 0)
library(writexl)
write_xlsx(
med.test,
path = here(fileext = here("paper/Tables/medications.xlsx")),
col_names = TRUE,
format_headers = TRUE,
use_zip64 = FALSE
)
med.test
View(med.test$CARBAMAZEPINE)
View(med.test$`VALPROIC ACID`)
View(med.test$NONE)
View(med.test$LEVETIRACETAM)
write_xlsx(
med.test,
path = here(fileext = here("paper/Tables/medications.xlsx")),
col_names = TRUE,
format_headers = TRUE,
use_zip64 = FALSE
)
write_xlsx(
med.test,
path = here(fileext = here("paper/Tables/comparison_medications.xlsx")),
col_names = TRUE,
format_headers = TRUE,
use_zip64 = FALSE
)
write_xlsx(
med.test,
path = here(fileext = here("paper/Tables/comparing_medications.xlsx")),
col_names = TRUE,
format_headers = TRUE,
use_zip64 = FALSE
)
write_xlsx(cor_age,fileext=here("paper/Tables/correlation_age.xlsx"))
write_xlsx(
med.test,
path = fileext = here("paper/Tables/comparing_medications.xlsx"),
write_xlsx(
med.test,
path = here("paper/Tables/comparing_medications.xlsx"),
col_names = TRUE,
format_headers = TRUE,
use_zip64 = FALSE
)
write_xlsx(cor_age,path = here("paper/Tables/correlation_age.xlsx"))
write_xlsx(comp_sex,path = here("paper/Tables/comparing_sex.xlsx"))
opsxplot <- opsx %>%
ggplot(aes(x=p1,y=o1,color=lab)) +
geom_point(size=3) +
stat_ellipse(geom = "polygon",
aes(fill = lab),
alpha = 0.25,
level = 0.8) +
coord_fixed(xlim = c(-10,10),ylim=c(-5,5)) +
theme_bw(base_size = 15) +
scale_color_manual(values=c("pink","lightblue"),labels=c("F","M"),drop = FALSE) +
scale_fill_manual(values=c("pink","lightblue"),labels=c("F","M"),drop = FALSE) +
theme(legend.title = element_blank()) +
geom_vline(xintercept=0) +
geom_hline(yintercept = 0)
ggsave(file=here("paper/Figures/OPLSDA_sex.png"),opsxplot, dpi = 1000, width = 8, height = 4)
ggsave(file=here("paper/Figures/OPLSDA_sex.png"),opsxplot, dpi = 500, width = 8, height = 4)
